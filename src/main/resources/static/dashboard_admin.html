<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Escolar - Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f5f5f5; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; }
        .btn-logout { background-color: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .btn-logout:hover { background-color: #f0f0f0; transform: translateY(-2px); }
        
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .filters { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .filters h3 { color: #667eea; margin-bottom: 15px; }
        .filter-group { display: flex; gap: 10px; align-items: end; flex-wrap: wrap; }
        .filter-group > div { flex: 1; min-width: 200px; }
        
        .sections-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); gap: 20px; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section h2 { color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 20px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #667eea; color: white; font-weight: 600; }
        tr:hover { background-color: #f5f5f5; }
        
        label { display: block; color: #333; font-weight: 500; margin-bottom: 5px; font-size: 14px; }
        input, select { width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: all 0.3s; margin-top: 10px; margin-right: 5px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background-color: #51cf66; color: white; }
        .btn-warning { background-color: #ffd43b; color: #333; }
        .btn-danger { background-color: #ff6b6b; color: white; }
        .btn-secondary { background-color: #e0e0e0; color: #333; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #667eea; margin: 0; }
        .close { font-size: 28px; font-weight: bold; cursor: pointer; color: #999; }
        .close:hover { color: #333; }
        .form-group { margin-bottom: 15px; }
        .filter-item { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .filter-item h4 { color: #667eea; margin-bottom: 10px; font-size: 16px; }
        .filter-controls { display: flex; gap: 10px; align-items: end; }
        .filter-controls > div { flex: 1; }
        .result-box { display: none; margin-top: 10px; padding: 12px; background: #e7f5ff; border-left: 4px solid #339af0; border-radius: 4px; }
        .result-box.show { display: block; }
        .result-box strong { color: #1971c2; }
    </style>
</head>
<body>

<div class="header">
    <h1>üéì Panel de Administrador - Sistema de Gesti√≥n Escolar</h1>
    <form action="/logout" method="post" style="margin: 0;">
        <button type="submit" class="btn-logout">üö™ Cerrar Sesi√≥n</button>
    </form>
</div>

<div class="container">
    <!-- Filtros -->
    <div class="filters">
        <h3>üîç Filtros de B√∫squeda</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            
            <!-- Filtro 1: Buscar alumno por c√©dula -->
            <div class="filter-item">
                <h4>üîé Buscar Alumno</h4>
                <div class="filter-controls">
                    <div>
                        <input type="text" id="filtroCedula" placeholder="Ingrese c√©dula del alumno">
                    </div>
                    <button class="btn-primary" onclick="buscarAlumnoPorCedula()">Buscar</button>
                </div>
            </div>

            <!-- Filtro 2: Ver curso de alumno -->
            <div class="filter-item">
                <h4>üìñ Curso del Alumno</h4>
                <div class="filter-controls">
                    <div>
                        <input type="text" id="filtroCursoCedula" placeholder="Ingrese c√©dula del alumno">
                    </div>
                    <button class="btn-primary" onclick="verCursoDeAlumno()">Buscar</button>
                </div>
                <div id="resultadoCurso" class="result-box"></div>
            </div>

            <!-- Filtro 3: Alumnos por curso -->
            <div class="filter-item">
                <h4>üë• Alumnos por Curso</h4>
                <div class="filter-controls">
                    <div>
                        <select id="filtroCursoId">
                            <option value="">Seleccione un curso</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="listarAlumnosPorCurso()">Buscar</button>
                </div>
            </div>

        </div>
        <button class="btn-secondary" onclick="limpiarFiltros()" style="margin-top: 15px;">üîÑ Limpiar Todos los Filtros</button>
    </div>

    <div class="sections-container">

        <!-- Secci√≥n de Cursos -->
        <div class="section">
            <h2>üìö Gesti√≥n de Cursos</h2>
            <button class="btn-primary" onclick="abrirModalCurso()">‚ûï Nuevo Curso</button>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Paralelo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tblCursos"></tbody>
            </table>
        </div>

        <!-- Secci√≥n de Alumnos -->
        <div class="section">
            <h2>üë®‚Äçüéì Gesti√≥n de Alumnos</h2>
            <button class="btn-primary" onclick="abrirModalAlumno()">‚ûï Nuevo Alumno</button>
            <table>
                <thead>
                    <tr>
                        <th>C√©dula</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Curso</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tblAlumnos"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Curso -->
<div id="modalCurso" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="tituloModalCurso">Nuevo Curso</h2>
            <span class="close" onclick="cerrarModalCurso()">&times;</span>
        </div>
        <form id="formCurso" onsubmit="event.preventDefault(); guardarCurso();">
            <input type="hidden" id="idCursoHidden">
            <div class="form-group">
                <label>Nombre del Curso:</label>
                <input type="text" id="nombreCurso" placeholder="Ej: Octavo A" minlength="3" maxlength="30" required>
            </div>
            <div class="form-group">
                <label>Paralelo:</label>
                <input type="text" id="paraleloCurso" placeholder="Ej: A" minlength="1" maxlength="10" required>
            </div>
            <button type="submit" class="btn-success">üíæ Guardar</button>
            <button type="button" class="btn-secondary" onclick="cerrarModalCurso()">‚úñ Cancelar</button>
        </form>
    </div>
</div>

<!-- Modal Alumno -->
<div id="modalAlumno" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="tituloModalAlumno">Nuevo Alumno</h2>
            <span class="close" onclick="cerrarModalAlumno()">&times;</span>
        </div>
        <form id="formAlumno" onsubmit="event.preventDefault(); guardarAlumno();">
            <div class="form-group">
                <label>C√©dula:</label>
                <input type="text" id="cedula" placeholder="1234567890" maxlength="10" 
                       pattern="[0-9]{10}" title="La c√©dula debe tener exactamente 10 d√≠gitos" required>
            </div>
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="nombre" placeholder="Juan" minlength="2" maxlength="20" required>
            </div>
            <div class="form-group">
                <label>Apellido:</label>
                <input type="text" id="apellido" placeholder="P√©rez" minlength="2" maxlength="20" required>
            </div>
            <div class="form-group">
                <label>Direcci√≥n:</label>
                <input type="text" id="direccion" placeholder="Calle Principal 123" maxlength="50" required>
            </div>
            <div class="form-group">
                <label>Tel√©fono:</label>
                <input type="text" id="telefono" placeholder="0987654321" maxlength="10" 
                       pattern="[0-9]{10}" title="El tel√©fono debe tener exactamente 10 d√≠gitos" required>
            </div>
            <div class="form-group">
                <label>Curso:</label>
                <select id="selectCursoAlumno" required>
                    <option value="">-- Seleccione un Curso --</option>
                </select>
            </div>
            <button type="submit" class="btn-success">üíæ Guardar</button>
            <button type="button" class="btn-secondary" onclick="cerrarModalAlumno()">‚úñ Cancelar</button>
        </form>
    </div>
</div>

<script>
    // URLS API
    const API_ALUMNOS = "/api/alumnos";
    const API_CURSOS = "/api/cursos";

    let modoEdicion = false;
    let cedulaEdicion = null;

    // AL CARGAR LA PAGINA
    document.addEventListener("DOMContentLoaded", init);

    async function init() {
        await mostrarCursos();
        await mostrarAlumnos();
        await cargarCursosEnSelects();
    }

    // ==========================================
    // MODALES
    // ==========================================
    function abrirModalCurso(id = null, nombre = '', paralelo = '') {
        document.getElementById('modalCurso').style.display = 'block';
        document.getElementById('idCursoHidden').value = id || '';
        document.getElementById('nombreCurso').value = nombre;
        document.getElementById('paraleloCurso').value = paralelo;
        document.getElementById('tituloModalCurso').textContent = id ? 'Editar Curso' : 'Nuevo Curso';
    }

    function cerrarModalCurso() {
        document.getElementById('modalCurso').style.display = 'none';
        document.getElementById('formCurso').reset();
    }

    function abrirModalAlumno(cedula = null) {
        document.getElementById('modalAlumno').style.display = 'block';
        document.getElementById('tituloModalAlumno').textContent = cedula ? 'Editar Alumno' : 'Nuevo Alumno';
        
        if (cedula) {
            modoEdicion = true;
            cedulaEdicion = cedula;
            cargarDatosAlumno(cedula);
            document.getElementById('cedula').disabled = true;
        } else {
            modoEdicion = false;
            cedulaEdicion = null;
            document.getElementById('cedula').disabled = false;
            document.getElementById('formAlumno').reset();
        }
    }

    function cerrarModalAlumno() {
        document.getElementById('modalAlumno').style.display = 'none';
        document.getElementById('formAlumno').reset();
        modoEdicion = false;
        cedulaEdicion = null;
    }

    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
        const modalCurso = document.getElementById('modalCurso');
        const modalAlumno = document.getElementById('modalAlumno');
        if (event.target == modalCurso) cerrarModalCurso();
        if (event.target == modalAlumno) cerrarModalAlumno();
    }

    // ==========================================
    // L√ìGICA DE CURSOS
    // ==========================================
    async function mostrarCursos() {
        try {
            const response = await fetch(API_CURSOS);
            const cursos = await response.json();
            const tabla = document.getElementById("tblCursos");
            tabla.innerHTML = "";

            cursos.forEach(c => {
                tabla.innerHTML += `
                    <tr>
                        <td>${c.idCurso}</td>
                        <td>${c.nombreCurso}</td>
                        <td>${c.paralelo || '-'}</td>
                        <td>
                            <button class="btn-warning" onclick="abrirModalCurso(${c.idCurso}, '${c.nombreCurso}', '${c.paralelo}')">‚úèÔ∏è Editar</button>
                            <button class="btn-danger" onclick="eliminarCurso(${c.idCurso})">üóëÔ∏è Eliminar</button>
                        </td>
                    </tr>`;
            });
        } catch (error) {
            console.error("Error al cargar cursos:", error);
            alert("Error al cargar cursos");
        }
    }

    async function guardarCurso() {
        const id = document.getElementById("idCursoHidden").value;
        const nombre = document.getElementById("nombreCurso").value;
        const paralelo = document.getElementById("paraleloCurso").value;

        const method = id ? "PUT" : "POST";
        const url = id ? `${API_CURSOS}/${id}` : API_CURSOS;

        try {
            const response = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nombreCurso: nombre, paralelo: paralelo })
            });

            if (response.ok) {
                cerrarModalCurso();
                await mostrarCursos();
                await cargarCursosEnSelects();
                alert(id ? "Curso actualizado correctamente" : "Curso creado correctamente");
            } else {
                const error = await response.json();
                alert(`Error: ${error.message || 'No se pudo guardar el curso'}`);
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error al conectar con el servidor");
        }
    }

    async function eliminarCurso(id) {
        if (!confirm("¬øEst√° seguro de eliminar este curso?")) return;
        
        try {
            const response = await fetch(`${API_CURSOS}/${id}`, { method: "DELETE" });
            if (response.ok) {
                await mostrarCursos();
                await cargarCursosEnSelects();
                alert("Curso eliminado correctamente");
            } else {
                const error = await response.json();
                alert(`Error: ${error.message || 'No se pudo eliminar el curso'}`);
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error al conectar con el servidor");
        }
    }

    async function cargarCursosEnSelects() {
        try {
            const response = await fetch(API_CURSOS);
            const cursos = await response.json();

            const select1 = document.getElementById("selectCursoAlumno");
            const select2 = document.getElementById("filtroCursoId");
            
            select1.innerHTML = '<option value="">-- Seleccione un Curso --</option>';
            select2.innerHTML = '<option value="">Todos los cursos</option>';

            cursos.forEach(c => {
                select1.innerHTML += `<option value="${c.idCurso}">${c.nombreCurso} (${c.paralelo})</option>`;
                select2.innerHTML += `<option value="${c.idCurso}">${c.nombreCurso} (${c.paralelo})</option>`;
            });
        } catch (error) {
            console.error("Error al cargar cursos:", error);
        }
    }

    // ==========================================
    // L√ìGICA DE ALUMNOS
    // ==========================================
    async function mostrarAlumnos() {
        try {
            const response = await fetch(API_ALUMNOS);
            const alumnos = await response.json();
            renderizarTablaAlumnos(alumnos);
        } catch (error) {
            console.error("Error al cargar alumnos:", error);
            alert("Error al cargar alumnos");
        }
    }

    function renderizarTablaAlumnos(lista) {
        const tabla = document.getElementById("tblAlumnos");
        tabla.innerHTML = "";

        lista.forEach(al => {
            let nombreCurso = al.curso ? `${al.curso.nombreCurso} (${al.curso.paralelo})` : "Sin Curso";

            tabla.innerHTML += `
                <tr>
                    <td>${al.cedula}</td>
                    <td>${al.nombre}</td>
                    <td>${al.apellido}</td>
                    <td>${nombreCurso}</td>
                    <td>
                        <button class="btn-warning" onclick="abrirModalAlumno('${al.cedula}')">‚úèÔ∏è Editar</button>
                        <button class="btn-danger" onclick="eliminarAlumno('${al.cedula}')">üóëÔ∏è Eliminar</button>
                    </td>
                </tr>`;
        });
    }

    async function cargarDatosAlumno(cedula) {
        try {
            const response = await fetch(`${API_ALUMNOS}/${cedula}`);
            const al = await response.json();

            document.getElementById("cedula").value = al.cedula;
            document.getElementById("nombre").value = al.nombre;
            document.getElementById("apellido").value = al.apellido;
            document.getElementById("direccion").value = al.direccion;
            document.getElementById("telefono").value = al.telefono;
            document.getElementById("selectCursoAlumno").value = al.curso ? al.curso.idCurso : "";
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar datos del alumno");
        }
    }

    async function guardarAlumno() {
        const cedula = document.getElementById("cedula").value;
        const data = {
            nombre: document.getElementById("nombre").value,
            apellido: document.getElementById("apellido").value,
            direccion: document.getElementById("direccion").value,
            telefono: document.getElementById("telefono").value,
            idCurso: parseInt(document.getElementById("selectCursoAlumno").value)
        };

        if (!data.idCurso) {
            alert("Por favor seleccione un curso");
            return;
        }

        try {
            let response;
            if (modoEdicion) {
                response = await fetch(`${API_ALUMNOS}/${cedula}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
            } else {
                response = await fetch(API_ALUMNOS, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ cedula, ...data })
                });
            }

            if (response.ok) {
                cerrarModalAlumno();
                await mostrarAlumnos();
                alert(modoEdicion ? "Alumno actualizado correctamente" : "Alumno creado correctamente");
            } else {
                const error = await response.json();
                alert(`Error: ${error.message || 'No se pudo guardar el alumno'}`);
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error al conectar con el servidor");
        }
    }

    async function eliminarAlumno(cedula) {
        if (!confirm(`¬øEst√° seguro de eliminar al alumno con c√©dula ${cedula}?`)) return;

        try {
            const response = await fetch(`${API_ALUMNOS}/${cedula}`, { method: "DELETE" });
            if (response.ok) {
                await mostrarAlumnos();
                alert("Alumno eliminado correctamente");
            } else {
                alert("Error al eliminar el alumno");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error al conectar con el servidor");
        }
    }

    // ==========================================
    // FILTROS
    // ==========================================
    
    // Filtro 1: Buscar alumno por c√©dula
    async function buscarAlumnoPorCedula() {
        const cedula = document.getElementById("filtroCedula").value.trim();
        if (!cedula) {
            alert("Por favor ingrese una c√©dula");
            return;
        }

        try {
            const response = await fetch(`${API_ALUMNOS}/${cedula}`);
            if (response.ok) {
                const alumno = await response.json();
                renderizarTablaAlumnos([alumno]);
            } else {
                alert("Alumno no encontrado");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error al buscar el alumno");
        }
    }

    // Filtro 2: Ver curso de un alumno
    async function verCursoDeAlumno() {
        const cedula = document.getElementById("filtroCursoCedula").value.trim();
        const resultadoDiv = document.getElementById("resultadoCurso");
        
        if (!cedula) {
            alert("Por favor ingrese una c√©dula");
            return;
        }

        try {
            const response = await fetch(`${API_ALUMNOS}/${cedula}/curso`);
            if (response.ok) {
                const curso = await response.json();
                resultadoDiv.innerHTML = `<strong>Curso:</strong> ${curso.nombreCurso} - <strong>Paralelo:</strong> ${curso.paralelo}`;
                resultadoDiv.classList.add("show");
            } else {
                resultadoDiv.innerHTML = `<strong>No se encontr√≥ el curso del alumno</strong>`;
                resultadoDiv.classList.add("show");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error al obtener el curso del alumno");
        }
    }

    // Filtro 3: Alumnos por curso
    async function listarAlumnosPorCurso() {
        const idCurso = document.getElementById("filtroCursoId").value;
        if (!idCurso) {
            alert("Por favor seleccione un curso");
            return;
        }

        try {
            const response = await fetch(`${API_ALUMNOS}/por-curso/${idCurso}`);
            if (response.ok) {
                const alumnos = await response.json();
                renderizarTablaAlumnos(alumnos);
            } else {
                alert("Error al obtener alumnos del curso");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error al aplicar filtro");
        }
    }

    function limpiarFiltros() {
        document.getElementById("filtroCedula").value = "";
        document.getElementById("filtroCursoCedula").value = "";
        document.getElementById("filtroCursoId").value = "";
        const resultadoDiv = document.getElementById("resultadoCurso");
        resultadoDiv.classList.remove("show");
        resultadoDiv.innerHTML = "";
        mostrarAlumnos();
    }
</script>

</body>
</html>